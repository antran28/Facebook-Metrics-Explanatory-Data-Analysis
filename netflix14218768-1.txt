DROP table netflix_customer CASCADE;
DROP table netflix_show CASCADE;
DROP table show_detail CASCADE;
DROP table customer_watch CASCADE;
DROP table artist CASCADE;
DROP table netflix_role CASCADE;
DROP table netflix_rating CASCADE;

CREATE TABLE netflix_show 
(
	showid		integer,
	showname	TEXT,
	showtype	char(2),
	CONSTRAINT netflix_showPK PRIMARY KEY (showid),

        CONSTRAINT di_table_netflix_show_showtype CHECK (showtype IN (
                'MO',   -- movie
                'SE'    -- series
                ))
);

CREATE TABLE show_detail 
(
	showid		integer	NOT NULL,
	showde_id	integer	NOT NULL,
	season		integer	NOT NULL,
	episode		integer	NOT NULL,
	length		integer	NOT NULL,
	description		TEXT,
	year_published 	integer	NOT NULL,
	genre			TEXT	NOT NULL,

	CONSTRAINT show_detailPK PRIMARY KEY (showde_id),
	CONSTRAINT show_detailFK FOREIGN KEY (showid)
							REFERENCES netflix_show ON DELETE CASCADE,

	CONSTRAINT di_table_show_detail_year_published CHECK
		((year_published >= 1950) AND (year_published <= 2021))
);
CREATE TABLE netflix_customer 
(
	customerid		integer,
	cusname		TEXT		NOT NULL,
	age			integer,
	location		char(15),
	email			varchar(30),
	CONSTRAINT netflix_customerPK PRIMARY KEY (customerid)
);

CREATE TABLE customer_watch
(
	customerid		integer	NOT NULL,
	showde_id		integer NOT NULL,
	datewatch		DATE,
	device		    char(2),

	CONSTRAINT customer_watchPK PRIMARY KEY (customerid, showde_id),
	CONSTRAINT customer_watchFK_id FOREIGN KEY (customerid) REFERENCES netflix_customer (customerid) ON UPDATE CASCADE,
	CONSTRAINT customer_watchFK_show FOREIGN KEY (showde_id) REFERENCES show_detail (showde_id) ON DELETE RESTRICT,

	CONSTRAINT di_table_customer_watch_device CHECK (device IN (
                'MP',   -- mobile phone
                'TA',   -- tablet
                'LA',   -- laptop
                'TV'    -- television
                ))
);

CREATE TABLE artist
(
	artistid	integer,
	artname		TEXT,
	birth		integer,
	death		integer,
	country		TEXT,
	gender		char(1),

	CONSTRAINT	artistPK PRIMARY KEY (artistid),

	CONSTRAINT di_table_artist_birth CHECK
		((birth >= 1900) AND (birth <= 2010)),
	CONSTRAINT di_table_artist_death CHECK
		((death IS NULL) OR ((death > birth) AND (death <= 2021))),
	CONSTRAINT di_table_artist_gender CHECK (gender IN (
                'M',   -- Male
                'F'))  -- Female
);

CREATE TABLE netflix_role
(
	artistid	integer	NOT NULL,
	showid		integer	NOT NULL,
	role		TEXT	NOT NULL,

	CONSTRAINT rolePK PRIMARY KEY (artistid, showid),
	CONSTRAINT roleFK_show FOREIGN KEY (showid) REFERENCES netflix_show (showid) ON DELETE CASCADE,
	CONSTRAINT roleFK_artist FOREIGN KEY (artistid) REFERENCES artist (artistid) ,

	CONSTRAINT di_table_netflix_role_role CHECK (role IN (
		'Director',
		'Cast',
		'Writer',
		'Creator'
        ))
);

CREATE TABLE netflix_rating
(
	showid		integer	NOT NULL,
	IDMB_rate	decimal(3,1),
	maturity_rate	varchar(5),

    CONSTRAINT netflix_ratingPK PRIMARY KEY (showid),
	CONSTRAINT netflix_ratingFK FOREIGN KEY (showid) REFERENCES netflix_show (showid),

	CONSTRAINT di_table_netflix_rating_maturity_rate CHECK (maturity_rate IN (
                'R18',   -- restricted to ages 18 and over
                'MA15',  -- not suitable for ages 14 and under
                'M',     -- recommended for mature audiences
                'PG',    -- parental guidance suggested
                'G'      -- suitable for general audiences
                ))
);

INSERT INTO netflix_show (showid, showname, showtype) VALUES (1, 'Shameless', 'SE');
INSERT INTO netflix_show (showid, showname, showtype) VALUES (3, 'Batman Begins', 'MO');
INSERT INTO netflix_show (showid, showname, showtype) VALUES (4, 'Despicable ME', 'MO');
INSERT INTO netflix_show (showid, showname, showtype) VALUES (5, 'The Shinning', 'MO');
INSERT INTO netflix_show (showid, showname, showtype) VALUES (2, 'Rick and Morty', 'SE');
INSERT INTO netflix_show (showid, showname, showtype) VALUES (6, 'Bridgerton', 'SE');

INSERT INTO show_detail (showid, showde_id, season, episode, length, description, year_published, genre) VALUES (1, 1, 1, 9, 57, 'Irreverent', 2011, 'Comedy');
INSERT INTO show_detail (showid, showde_id, season, episode, length, description, year_published, genre) VALUES (1, 2, 1, 10, 55, 'Irreverent', 2011, 'Comedy');
INSERT INTO show_detail (showid, showde_id, season, episode, length, description, year_published, genre) VALUES (1, 3, 2, 1, 45, 'Irreverent', 2011, 'Comedy');
INSERT INTO show_detail (showid, showde_id, season, episode, length, description, year_published, genre) VALUES (2, 4, 3, 5, 22, 'Quirky', 2019, 'Animation');
INSERT INTO show_detail (showid, showde_id, season, episode, length, description, year_published, genre) VALUES (3, 5, 0, 0, 139, 'Exciting', 2005, 'Action');
INSERT INTO show_detail (showid, showde_id, season, episode, length, description, year_published, genre) VALUES (4, 6, 0, 0, 94, 'Exciting', 2010, 'Animation');
INSERT INTO show_detail (showid, showde_id, season, episode, length, description, year_published, genre) VALUES (5, 7, 0, 0, 119, 'Scary', 1980, 'Horror');
INSERT INTO show_detail (showid, showde_id, season, episode, length, description, year_published, genre) VALUES (6, 8, 1, 1, 58, 'Emotional', 2020, 'Romance');
INSERT INTO show_detail (showid, showde_id, season, episode, length, description, year_published, genre) VALUES (6, 9, 1, 2, 61, 'Emotional', 2020, 'Romance');
INSERT INTO show_detail (showid, showde_id, season, episode, length, description, year_published, genre) VALUES (6, 10, 1, 3, 61, 'Emotional', 2020, 'Romance');

INSERT INTO netflix_customer (customerid, cusname, age, location, email) VALUES (1, 'Frank Gallagher', 30, 'Sydney', 'frank@gmail.com');
INSERT INTO netflix_customer (customerid, cusname, age, location, email) VALUES (2, 'Simon Cole', 32, 'Melbourne', 'simon@gmail.com');
INSERT INTO netflix_customer (customerid, cusname, age, location, email) VALUES (3, 'Anne Macy', 22, 'Sydney', 'anne@gmail.com');
INSERT INTO netflix_customer (customerid, cusname, age, location, email) VALUES (4, 'John Fisher', 25, 'Perth', 'john@gmail.com');
INSERT INTO netflix_customer (customerid, cusname, age, location, email) VALUES (5, 'Liam Kenny', 19, 'Sydney', 'liam@gmail.com');
INSERT INTO netflix_customer (customerid, cusname, age, location, email) VALUES (6, 'Emma Lyn', 20, 'Melbourne', 'emma@gmail.com');


INSERT INTO customer_watch (customerid, showde_id, datewatch, device) VALUES (1, 1, '2021-04-20', 'MP');
INSERT INTO customer_watch (customerid, showde_id, datewatch, device) VALUES (1, 2, '2021-04-20', 'MP');
INSERT INTO customer_watch (customerid, showde_id, datewatch, device) VALUES (1, 3, '2021-04-21', 'LA');
INSERT INTO customer_watch (customerid, showde_id, datewatch, device) VALUES (2, 4, '2021-04-24', 'MP');
INSERT INTO customer_watch (customerid, showde_id, datewatch, device) VALUES (2, 5, '2021-04-22', 'TA');
INSERT INTO customer_watch (customerid, showde_id, datewatch, device) VALUES (3, 7, '2021-04-20', 'TV');
INSERT INTO customer_watch (customerid, showde_id, datewatch, device) VALUES (4, 7, '2021-04-25', 'MP');
INSERT INTO customer_watch (customerid, showde_id, datewatch, device) VALUES (5, 8, '2021-04-26', 'TV');
INSERT INTO customer_watch (customerid, showde_id, datewatch, device) VALUES (5, 9, '2021-04-27', 'MP');
INSERT INTO customer_watch (customerid, showde_id, datewatch, device) VALUES (5, 10, '2021-04-29', 'MP');
INSERT INTO customer_watch (customerid, showde_id, datewatch, device) VALUES (4, 6, '2021-04-30', 'LA');

INSERT INTO artist (artistid, artname, birth, death, country, gender) VALUES (1, 'William H. Macy', 1950, NULL, 'USA', 'M');
INSERT INTO artist (artistid, artname, birth, death, country, gender) VALUES (2, 'John Wells', 1963, NULL, 'USA', 'M');
INSERT INTO artist (artistid, artname, birth, death, country, gender) VALUES (3, 'Dan Harmon', 1964, NULL, 'USA', 'M');
INSERT INTO artist (artistid, artname, birth, death, country, gender) VALUES (4, 'Katie Holmes', 1977, NULL, 'USA', 'F');
INSERT INTO artist (artistid, artname, birth, death, country, gender) VALUES (5, 'Pierre Coffin', 1971, NULL, 'France', 'M');
INSERT INTO artist (artistid, artname, birth, death, country, gender) VALUES (6, 'Shelley Duvall', 1952, NULL, 'USA', 'F');
INSERT INTO artist (artistid, artname, birth, death, country, gender) VALUES (7, 'Diane Johnson', 1938, NULL, 'USA', 'F');
INSERT INTO artist (artistid, artname, birth, death, country, gender) VALUES (8, 'Julie Andrews', 1939, NULL, 'England', 'F');

INSERT INTO netflix_role (artistid, showid, role) VALUES (1, 1, 'Cast');
INSERT INTO netflix_role (artistid, showid, role) VALUES (2, 1, 'Creator');
INSERT INTO netflix_role (artistid, showid, role) VALUES (3, 2, 'Creator');
INSERT INTO netflix_role (artistid, showid, role) VALUES (4, 3, 'Cast');
INSERT INTO netflix_role (artistid, showid, role) VALUES (5, 4, 'Director');
INSERT INTO netflix_role (artistid, showid, role) VALUES (6, 5, 'Cast');
INSERT INTO netflix_role (artistid, showid, role) VALUES (7, 5, 'Writer');
INSERT INTO netflix_role (artistid, showid, role) VALUES (8, 1, 'Cast');

INSERT INTO netflix_rating (showid, IDMB_rate, maturity_rate) VALUES (1, 8.6, 'R18');
INSERT INTO netflix_rating (showid, IDMB_rate, maturity_rate) VALUES (2, 9.2, 'MA15');
INSERT INTO netflix_rating (showid, IDMB_rate, maturity_rate) VALUES (3, 8.2, 'M');
INSERT INTO netflix_rating (showid, IDMB_rate, maturity_rate) VALUES (4, 7.5, 'PG');
INSERT INTO netflix_rating (showid, IDMB_rate, maturity_rate) VALUES (5, 9.0, 'MA15');
INSERT INTO netflix_rating (showid, IDMB_rate, maturity_rate) VALUES (6, 7.9, 'MA15');

CREATE VIEW NetflixSeries AS 
	SELECT showname as name, showtype as classification, count(season) as season, description, year_published as year, genre 
	from netflix_show natural join show_detail 
	where showtype = 'SE' 
	group by showname, showtype, description, year_published, genre;

CREATE VIEW NetflixArtist AS SELECT a.artname, a.birth, a.country, a.gender, b.role, c.showname as artwork 
	from netflix_show c, netflix_role b, artist a 
	where a.artistid = b.artistid and b.showid = c.showid;

